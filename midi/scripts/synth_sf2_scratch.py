
# from sf2utils.sf2parse import Sf2File
# sf2_path = "/home/smith/Agon/mystuff/assets/sound/sf2/FluidR3_GM/FluidR3_GM.sf2"
# with open(sf2_path, "rb") as f:
#     sf2 = Sf2File(f)
#     real_presets = [p for p in sf2.presets if getattr(p, "name", "") != "EOP"]
#     real_presets = sorted(real_presets, key=lambda p: (p.bank, p.preset))
#     for p in real_presets:
#         print(f"Bank {p.bank}, Preset {p.preset}: {p.name}")


# Bank 0, Preset 0: Yamaha Grand Piano
# Bank 0, Preset 1: Bright Yamaha Grand
# Bank 0, Preset 2: Electric Piano
# Bank 0, Preset 3: Honky Tonk
# Bank 0, Preset 4: Rhodes EP
# Bank 0, Preset 5: Legend EP 2
# Bank 0, Preset 6: Harpsichord
# Bank 0, Preset 7: Clavinet
# Bank 0, Preset 8: Celesta
# Bank 0, Preset 9: Glockenspiel
# Bank 0, Preset 10: Music Box
# Bank 0, Preset 11: Vibraphone
# Bank 0, Preset 12: Marimba
# Bank 0, Preset 13: Xylophone
# Bank 0, Preset 14: Tubular Bells
# Bank 0, Preset 15: Dulcimer
# Bank 0, Preset 16: DrawbarOrgan
# Bank 0, Preset 17: Percussive Organ
# Bank 0, Preset 18: Rock Organ
# Bank 0, Preset 19: Church Organ
# Bank 0, Preset 20: Reed Organ
# Bank 0, Preset 21: Accordian
# Bank 0, Preset 22: Harmonica
# Bank 0, Preset 23: Bandoneon
# Bank 0, Preset 24: Nylon String Guitar
# Bank 0, Preset 25: Steel String Guitar
# Bank 0, Preset 26: Jazz Guitar
# Bank 0, Preset 27: Clean Guitar
# Bank 0, Preset 28: Palm Muted Guitar
# Bank 0, Preset 29: Overdrive Guitar
# Bank 0, Preset 30: Distortion Guitar
# Bank 0, Preset 31: Guitar Harmonics
# Bank 0, Preset 32: Acoustic Bass
# Bank 0, Preset 33: Fingered Bass
# Bank 0, Preset 34: Picked Bass
# Bank 0, Preset 35: Fretless Bass
# Bank 0, Preset 36: Slap Bass
# Bank 0, Preset 37: Pop Bass
# Bank 0, Preset 38: Synth Bass 1
# Bank 0, Preset 39: Synth Bass 2
# Bank 0, Preset 40: Violin
# Bank 0, Preset 41: Viola
# Bank 0, Preset 42: Cello
# Bank 0, Preset 43: Contrabass
# Bank 0, Preset 44: Tremolo
# Bank 0, Preset 45: Pizzicato Section
# Bank 0, Preset 46: Harp
# Bank 0, Preset 47: Timpani
# Bank 0, Preset 48: Strings
# Bank 0, Preset 49: Slow Strings
# Bank 0, Preset 50: Synth Strings 1
# Bank 0, Preset 51: Synth Strings 2
# Bank 0, Preset 52: Ahh Choir
# Bank 0, Preset 53: Ohh Voices
# Bank 0, Preset 54: Synth Voice
# Bank 0, Preset 55: Orchestra Hit
# Bank 0, Preset 56: Trumpet
# Bank 0, Preset 57: Trombone
# Bank 0, Preset 58: Tuba
# Bank 0, Preset 59: Muted Trumpet
# Bank 0, Preset 60: French Horns
# Bank 0, Preset 61: Brass Section
# Bank 0, Preset 62: Synth Brass 1
# Bank 0, Preset 63: Synth Brass 2
# Bank 0, Preset 64: Soprano Sax
# Bank 0, Preset 65: Alto Sax
# Bank 0, Preset 66: Tenor Sax
# Bank 0, Preset 67: Baritone Sax
# Bank 0, Preset 68: Oboe
# Bank 0, Preset 69: English Horn
# Bank 0, Preset 70: Bassoon
# Bank 0, Preset 71: Clarinet
# Bank 0, Preset 72: Piccolo
# Bank 0, Preset 73: Flute
# Bank 0, Preset 74: Recorder
# Bank 0, Preset 75: Pan Flute
# Bank 0, Preset 76: Bottle Chiff
# Bank 0, Preset 77: Shakuhachi
# Bank 0, Preset 78: Whistle
# Bank 0, Preset 79: Ocarina
# Bank 0, Preset 80: Square Lead
# Bank 0, Preset 81: Saw Wave
# Bank 0, Preset 82: Calliope Lead
# Bank 0, Preset 83: Chiffer Lead
# Bank 0, Preset 84: Charang
# Bank 0, Preset 85: Solo Vox
# Bank 0, Preset 86: Fifth Sawtooth Wave
# Bank 0, Preset 87: Bass & Lead
# Bank 0, Preset 88: Fantasia
# Bank 0, Preset 89: Warm Pad
# Bank 0, Preset 90: Polysynth
# Bank 0, Preset 91: Space Voice
# Bank 0, Preset 92: Bowed Glass
# Bank 0, Preset 93: Metal Pad
# Bank 0, Preset 94: Halo Pad
# Bank 0, Preset 95: Sweep Pad
# Bank 0, Preset 96: Ice Rain
# Bank 0, Preset 97: Soundtrack
# Bank 0, Preset 98: Crystal
# Bank 0, Preset 99: Atmosphere
# Bank 0, Preset 100: Brightness
# Bank 0, Preset 101: Goblin
# Bank 0, Preset 102: Echo Drops
# Bank 0, Preset 103: Star Theme
# Bank 0, Preset 104: Sitar
# Bank 0, Preset 105: Banjo
# Bank 0, Preset 106: Shamisen
# Bank 0, Preset 107: Koto
# Bank 0, Preset 108: Kalimba
# Bank 0, Preset 109: BagPipe
# Bank 0, Preset 110: Fiddle
# Bank 0, Preset 111: Shenai
# Bank 0, Preset 112: Tinker Bell
# Bank 0, Preset 113: Agogo
# Bank 0, Preset 114: Steel Drums
# Bank 0, Preset 115: Woodblock
# Bank 0, Preset 116: Taiko Drum
# Bank 0, Preset 117: Melodic Tom
# Bank 0, Preset 118: Synth Drum
# Bank 0, Preset 119: Reverse Cymbal
# Bank 0, Preset 120: Fret Noise
# Bank 0, Preset 121: Breath Noise
# Bank 0, Preset 122: Sea Shore
# Bank 0, Preset 123: Bird Tweet
# Bank 0, Preset 124: Telephone
# Bank 0, Preset 125: Helicopter
# Bank 0, Preset 126: Applause
# Bank 0, Preset 127: Gun Shot
# Bank 8, Preset 4: Detuned EP 1
# Bank 8, Preset 5: Detuned EP 2
# Bank 8, Preset 6: Coupled Harpsichord
# Bank 8, Preset 14: Church Bell
# Bank 8, Preset 16: Detuned Organ 1
# Bank 8, Preset 17: Detuned Organ 2
# Bank 8, Preset 19: Church Organ 2
# Bank 8, Preset 21: Italian Accordion
# Bank 8, Preset 24: Ukulele
# Bank 8, Preset 25: 12 String Guitar
# Bank 8, Preset 26: Hawaiian Guitar
# Bank 8, Preset 28: Funk Guitar
# Bank 8, Preset 30: Feedback Guitar
# Bank 8, Preset 31: Guitar Feedback
# Bank 8, Preset 38: Synth Bass 3
# Bank 8, Preset 39: Synth Bass 4
# Bank 8, Preset 40: Slow Violin
# Bank 8, Preset 48: Orchestral Pad
# Bank 8, Preset 50: Synth Strings 3
# Bank 8, Preset 61: Brass 2
# Bank 8, Preset 62: Synth Brass 3
# Bank 8, Preset 63: Synth Brass 4
# Bank 8, Preset 80: Sine Wave
# Bank 8, Preset 107: Taisho Koto
# Bank 8, Preset 115: Castanets
# Bank 8, Preset 116: Concert Bass Drum
# Bank 8, Preset 117: Melo Tom 2
# Bank 8, Preset 118: 808 Tom
# Bank 9, Preset 125: Burst Noise
# Bank 16, Preset 25: Mandolin
# Bank 128, Preset 0: Standard
# Bank 128, Preset 1: Standard 1
# Bank 128, Preset 2: Standard 2
# Bank 128, Preset 3: Standard 3
# Bank 128, Preset 4: Standard 4
# Bank 128, Preset 5: Standard 5
# Bank 128, Preset 6: Standard 6
# Bank 128, Preset 7: Standard 7
# Bank 128, Preset 8: Room
# Bank 128, Preset 9: Room 1
# Bank 128, Preset 10: Room 2
# Bank 128, Preset 11: Room 3
# Bank 128, Preset 12: Room 4
# Bank 128, Preset 13: Room 5
# Bank 128, Preset 14: Room 6
# Bank 128, Preset 15: Room 7
# Bank 128, Preset 16: Power
# Bank 128, Preset 17: Power 1
# Bank 128, Preset 18: Power 2
# Bank 128, Preset 19: Power 3
# Bank 128, Preset 24: Electronic
# Bank 128, Preset 25: TR-808
# Bank 128, Preset 32: Jazz
# Bank 128, Preset 33: Jazz 1
# Bank 128, Preset 34: Jazz 2
# Bank 128, Preset 35: Jazz 3
# Bank 128, Preset 36: Jazz 4
# Bank 128, Preset 40: Brush
# Bank 128, Preset 41: Brush 1
# Bank 128, Preset 42: Brush 2
# Bank 128, Preset 48: Orchestra Kit

# import os
# from sf2utils.sf2parse import Sf2File

# # Configuration
# sf2_path = "/home/smith/Agon/mystuff/assets/sound/sf2/FluidR3_GM/FluidR3_GM.sf2"
# out_dir   = "midi/sf2"
# out_file  = os.path.join(out_dir, "FluidR3_GM.txt")

# # Ensure output directory exists
# os.makedirs(out_dir, exist_ok=True)

# # Parse and write summary
# with open(out_file, "w") as f:
#     # 1) reference the original SF2
#     f.write(f"{sf2_path}\n\n")
#     # 2) load and dump the Yamaha Grand Piano preset
#     with open(sf2_path, "rb") as sf2_file:
#         sf2 = Sf2File(sf2_file)
#         for preset in sf2.presets:
#             if preset.bank == 0 and preset.preset == 0:
#                 f.write(preset.pretty_print())
#                 break

# print(f"Wrote SF2 summary to {out_file}")


# =======================================================================

import re

def match_zone(line, key, velocity):
    # Example: "keys: [60, 72]   vels: [0, 127]"
    key_match = re.search(r'keys:\s*\[?(\d+),\s*(\d+)\]?', line)
    vel_match = re.search(r'vels:\s*\[?(\d+),\s*(\d+)\]?', line)
    if key_match:
        k1, k2 = int(key_match[1]), int(key_match[2])
        if not (k1 <= key <= k2):
            return False
    if vel_match:
        v1, v2 = int(vel_match[1]), int(vel_match[2])
        if not (v1 <= velocity <= v2):
            return False
    return True  # matches if in range

def extract_matching_zones(txt_path, key=69, velocity=64):
    with open(txt_path, 'r') as f:
        lines = f.readlines()

    matches = []
    block = []
    capturing = False
    current_applies = False

    for line in lines:
        line = line.rstrip()

        # Start of a new zone/bag
        if line.startswith("Bag #") or line.startswith("Preset["):
            # Finish previous block
            if capturing and current_applies:
                matches.append('\n'.join(block))
            block = [line]
            capturing = True
            current_applies = False
            continue

        if capturing:
            block.append(line)
            if 'keys:' in line or 'vels:' in line:
                if match_zone(line, key, velocity):
                    current_applies = True

    # Catch last block
    if capturing and current_applies:
        matches.append('\n'.join(block))

    return matches


# sample_lines = []
# matches = extract_matching_zones("midi/sf2/FluidR3_GM.txt", key=69, velocity=64)

# for m in matches:
#     for line in m.splitlines():
#         if "sample #" in line:
#             sample_lines.append(line.strip())

# # deduplicate
# unique_samples = sorted(set(sample_lines), key=lambda x: int(x.split('#')[1]))
# for line in unique_samples:
#     print(line)

# =======================================================================

def extract_sf2_sample(sf2_path: str, sample_index: int, output_dir: str) -> str:
    """
    Extracts sample #sample_index from sf2_path and writes it as
    output_dir/<sample_index>.wav (16-bit PCM) at its native sample rate.
    """
    import os, numpy as np, soundfile as sf
    from sf2utils.sf2parse import Sf2File

    # 1) Open and parse, keeping the file open
    f = open(sf2_path, "rb")
    sf2 = Sf2File(f)

    # 2) Get sample object
    try:
        smp = sf2.samples[sample_index]
    except IndexError:
        f.close()
        raise IndexError(f"Sample index {sample_index} out of range")

    # 3) Read raw bytes
    raw_bytes = smp.raw_sample_data
    f.close()

    # 4) Decode to float32 array
    if smp.sample_width == 2:
        int_data = np.frombuffer(raw_bytes, dtype="<i2")
        data = int_data.astype(np.float32) / 32768.0
    elif smp.sample_width == 1:
        u8 = np.frombuffer(raw_bytes, dtype=np.uint8)
        data = (u8.astype(np.float32) - 128.0) / 128.0
    else:
        # fall back to raw interpretation
        data = np.frombuffer(raw_bytes, dtype=np.float32)

    # 5) Write out
    os.makedirs(output_dir, exist_ok=True)
    out_path = os.path.join(output_dir, f"{sample_index}.wav")
    sf.write(out_path, data, smp.sample_rate, subtype="PCM_16")

    return out_path



# if __name__ == "__main__":
#     # Configuration
#     sf2_path       = "/home/smith/Agon/mystuff/assets/sound/sf2/FluidR3_GM/FluidR3_GM.sf2"
#     txt_summary    = "midi/sf2/FluidR3_GM.txt"
#     output_dir     = "midi/sf2/samples"
#     key            = 69
#     velocity       = 64

#     # 1) Find matching zones and extract sample lines
#     sample_lines = []
#     matches = extract_matching_zones(txt_summary, key=key, velocity=velocity)
#     for m in matches:
#         for line in m.splitlines():
#             if "sample #" in line:
#                 sample_lines.append(line.strip())

#     # 2) Deduplicate and sort
#     unique_samples = sorted(
#         set(sample_lines),
#         key=lambda x: int(x.split('#')[1])
#     )

#     # 3) Extract each sample from the SF2
#     for line in unique_samples:
#         idx = int(line.split('#')[1])
#         wav_path = extract_sf2_sample(sf2_path, idx, output_dir)
#         print(f"Extracted sample #{idx} → {wav_path}")

# ========================================================================

from sf2utils.sf2parse import Sf2File

def print_sample_loop_info(sf2_path: str, sample_index: int):
    """
    Print loop point metadata for the given sample index in the SF2 file.
    """
    with open(sf2_path, "rb") as f:
        sf2 = Sf2File(f)
        if sample_index < 0 or sample_index >= len(sf2.samples):
            print(f"Invalid sample index: {sample_index}")
            return
        sample = sf2.samples[sample_index]
        print(f"Sample {sample_index}: {sample.name}")
        print(f"  Sample rate: {sample.sample_rate} Hz")
        print(f"  Original pitch: MIDI {sample.original_pitch} (correction: {sample.pitch_correction} cents)")
        print(f"  Start index: {sample.start}")
        print(f"  End index: {sample.end}")
        print(f"  Loop start: {sample.start_loop}")
        print(f"  Loop end: {sample.end_loop}")
        print(f"  Duration: {sample.duration} samples")
        if sample.start_loop < sample.end_loop:
            loop_len = sample.end_loop - sample.start_loop
            print(f"  Loop length: {loop_len} samples ({loop_len / sample.sample_rate:.4f} seconds)")
        else:
            print("  No loop defined.")

# Run the function for sample 1133
if __name__ == "__main__":
    sf2_path = "/home/smith/Agon/mystuff/assets/sound/sf2/FluidR3_GM/FluidR3_GM.sf2"
    print_sample_loop_info(sf2_path, sample_index=1133)

